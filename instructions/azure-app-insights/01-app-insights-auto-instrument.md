---
lab:
  topic: Application Insights
  title: 自動インストルメンテーションを使用してアプリケーションを監視する
  description: '自動インストルメンテーションを構成することで、コードを変更せずに Application Insights でアプリケーションを監視する方法について説明します '
---

# 自動インストルメンテーションを使用してアプリケーションを監視する

この演習では、Application Insights を有効にして Azure App Service Web アプリを作成し、コードを変更せずに自動インストルメンテーションを構成し、Blazor アプリケーションを作成してデプロイし、Application Insights でアプリケーション メトリックとエラー データを表示します。 コードを変更することなく包括的なアプリケーション監視と観測性を実装することで、デプロイと移行が簡単になります。

この演習で実行されるタスク:

* Application Insights を有効にして Web アプリ リソースを作成する
* Web アプリのインストルメンテーションを構成します。
* 新しい Blazor アプリを作成し、Web アプリ リソースにデプロイします。
* Application Insights でアプリケーション アクティビティを表示する
* リソースをクリーンアップする

この演習の所要時間は約 **20** 分です。

## Azure でリソースを作成する

1. お使いのブラウザーで Azure portal ([https://portal.azure.com](https://portal.azure.com)) に移動し、メッセージに応じて Azure 資格情報を使用してサインインします。
1. ホーム ページの上の方の **Azure Services** 見出し内にある **[+ Create a resource]** を選択します。 
1. **[Search the Marketplace]** 検索バーに「*Web アプリ*」と入力し、**Enter** キーを押して検索を開始します。
1. Web App タイル内で **[Create]** ドロップダウンを選択し、**[Web App]** を選択します。

    ![Web App タイルのスクリーンショット。](./media/create-web-app-tile.png)

**[Create]** を選択すると、デプロイに関する情報を入力するいくつかのタブを含むテンプレートが開きます。 次の手順以降では、関連する各タブ内で行う変更について説明します。

1. **[Basics]** タブでは、以下の表に情報を入力します。

    | 設定 | アクション |
    |--|--|
    | **サブスクリプション** | 既定値のままにします。 |
    | **リソース グループ** | [Create new] を選択して `rg-WebApp` と入力し、[OK] を選択します。 既存のリソース グループを選択してもかまいません。 |
    | **名前** | 一意の名前を入力します (たとえば **YOUR-INITIALS-monitorapp**)。 **YOUR-INITIALS** を自分のイニシャルまたは他の値に置き換えます。 名前は一意でなければならないため、いくつかの変更が必要になる場合があります。 |
    | **[Name]** 設定の下のスライダー | スライダーを選択してオフにします。 このスライダーは一部の Azure 構成でのみ表示されます。 |
    | **発行** | **[コード]** オプションを選択します。 |
    | **ランタイム スタック** | ドロップダウン メニューで **[.NET 8 (LTS)]** を選択します。 |
    | **オペレーティング システム** | **[Windows]** を選択します。 |
    | **リージョン** | 既定の選択を保持するか、あるいは最寄りのリージョンを選択します。 |
    | **Windows プラン** | 既定の選択を保持します。 |
    | **料金プラン** | ドロップダウンを選択し、**[Free F1]** プランを選択します。 |

1. **[監視とセキュリティ]** タブを選択するか、このタブに移動して、次の表の情報を入力します。

    | 設定 | アクション |
    |--|--|
    | **[Application Insights を有効にする]** | **[はい]** を選択します。 |
    | **Application Insights** | **[新規作成]** を選択します。ダイアログ ボックスが表示されます。 ダイアログ ボックスの **[名前]** フィールドに「`autoinstrument-insights`」と入力します。 次に、**[OK]** を選択して名前を受け入れます。 |
    | **ワークスペース** | フィールドがまだ入力されておらず、ロックされていない場合は、「`Workspace`」と入力します。 |

1. **[確認と作成]** を選択し、デプロイの詳細を確認します。 次に、**[作成]** を選択してリソースを作成します。

デプロイが完了するまで数分かかります。 完了したら、**[リソースに移動]** ボタンを選択します。

### インストルメンテーション設定を構成する

コードを変更せずに監視を有効にするには、サービス レベルでアプリのインストルメンテーションを構成する必要があります。

1. 左側のナビゲーション メニューの **[監視]** を展開し、**[Application Insights]** を選択します。

1. **[アプリケーションのインストルメンテーション]** セクションを見つけて **[.NET Core]** を選択します。

1. **[コレクション レベル]** セクションで **[推奨]** を選択します。

1. **[適用]** を選択して変更を確認します。

1. 左側のナビゲーション メニューで、**[概要]** を選択します。

## Blazor アプリを作成してデプロイする

演習のこのセクションでは、Cloud Shell で Blazor アプリを作成し、作成した Web アプリにデプロイします。 このセクションのすべての手順は Cloud Shell で実行されます。

1. ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal 内に新しいクラウド シェルを作成します。***Bash*** 環境を選択すること。 Azure portal の下部にあるペインに、Cloud Shell のコマンド ライン インターフェイスが表示されます。 ファイルを保持するストレージ アカウントを選択するように求められた場合は、**[ストレージ アカウントは必要ありません]**、お使いのサブスクリプションを選択し、**[適用]** を選択します。

    > **注**: *PowerShell* 環境を使用するクラウド シェルを以前に作成している場合は、それを ***Bash*** に切り替えること。

1. 次のコマンドを実行して Blazor アプリ用のディレクトリを作成し、そのディレクトリに移動します。

    ```
    mkdir blazor
    cd blazor
    ```

1. 次のコマンドを実行して、フォルダーに新しい Blazor アプリを作成します。

    ```
    dotnet new blazor
    ```

1. 次のコマンドを実行してアプリケーションをビルドし、作成中に問題が発生しなかったことを確認します。

    ```
    dotnet build
    ```

### アプリを App Service にデプロイする

アプリをデプロイするには、まず **dotnet publish** コマンドで発行し、次にデプロイ用に *.zip* ファイルを作成する必要があります。

1. 次のコマンドを実行して、アプリを *publish* ディレクトリに発行します。

    ```
    dotnet publish -c Release -o ./publish
    ```

1. 次のコマンドを実行して、発行されたアプリの *.zip* ファイルを作成します。 *.zip* ファイルはアプリケーションのルート ディレクトリに配置されます。

    ```
    cd publish
    zip -r ../app.zip .
    cd ..
    ```

1. 次のコマンドを実行して、アプリを App Service にデプロイします。 **YOUR-WEB-APP-NAME** と **YOUR-RESOURCE-GROUP** を、この演習の前半で App Service リソースを作成するときに使用した値に置き換えます。

    ```
    az webapp deploy --name YOUR-WEB-APP-NAME \
        --resource-group YOUR-RESOURCE-GROUP \
        --src-path ./app.zip
    ```

1. デプロイが完了したら、**[基本情報]** セクションにある **[既定のドメイン]** フィールドのリンクを選択して、ブラウザーの新しいタブでアプリを開きます。

次に、Application Insights でいくつかの基本的なアプリケーション メトリックを確認します。 このタブは閉じないでください。演習の残りの部分で使用します。

## Application Insights でメトリックを表示する

Azure Portal のタブに戻り、先ほど作成した Application Insights リソースに移動します。 **[概要]** タブには、いくつかの基本的なグラフが表示されます。

* 失敗した要求
* サーバーの応答時間
* サーバー要求
* 可用性

このセクションでは、Web アプリでいくつかのアクションを実行し、このページに戻ってアクティビティを表示します。 アクティビティ レポートは遅れて作成されるため、グラフに表示されるまでに数分かかる場合があります。

Web アプリで次の手順を実行します。

1. Web アプリのメニューで、**[Home]**、**[+ Counter]**、**[Weather]** のナビゲーション オプション間を移動します。

1. Web ページを数回更新して、**[サーバー応答時間]** と **[サーバー要求]** のデータを生成します。

1. エラーを作成するために、**[Home]** ボタンを選択し、URL に「**/failures**」を追加します。 このルートは Web アプリには存在しないため、エラーが発生します。 ページを数回更新してエラー データを生成します。

1. Application Insights が実行されているタブに戻り、グラフに情報が表示されるまで 1 分から 2 分待ちます。 

1. 左側のナビゲーションで **[調査]** セクションを展開し、**[エラー]** を選択します。 失敗した要求数と、失敗に対する応答コードに関する詳細情報が表示されます。

他のレポート オプションを調べ、使用できる情報の種類を確認します。 

## リソースをクリーンアップする

これで演習が完了したので、不要なリソース使用を避けるために、作成したクラウド リソースを削除してください。

1. 作成したリソース グループに移動し、この演習で使用したリソースの内容を表示します。
1. ツール バーの **[リソース グループの削除]** を選びます。
1. リソース グループ名を入力し、削除することを確認します。

> **注:** リソース グループを削除すると、その中のすべてのリソースが削除されます。 この演習で既存のリソース グループを選択した場合は、この演習の範囲外にある既存のリソースも削除されます。
